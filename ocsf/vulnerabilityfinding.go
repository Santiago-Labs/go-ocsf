package ocsf

import (
	"encoding/json"
	"time"

	"github.com/apache/arrow/go/v15/arrow"
)

var VulnerabilityFindingFields = []arrow.Field{
	{Name: "event_day", Type: arrow.FixedWidthTypes.Date64, Nullable: false},
	{Name: "filename", Type: arrow.BinaryTypes.String, Nullable: false},
	{Name: "time", Type: arrow.FixedWidthTypes.Date64, Nullable: false},
	{Name: "activity_id", Type: arrow.PrimitiveTypes.Int32, Nullable: false},
	{Name: "activity_name", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "category_uid", Type: arrow.PrimitiveTypes.Int32, Nullable: false},
	{Name: "category_name", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "class_uid", Type: arrow.PrimitiveTypes.Int32, Nullable: false},
	{Name: "class_name", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "comment", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "confidence", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "confidence_id", Type: arrow.PrimitiveTypes.Int32, Nullable: true},
	{Name: "confidence_score", Type: arrow.PrimitiveTypes.Int32, Nullable: true},
	{Name: "count", Type: arrow.PrimitiveTypes.Int32, Nullable: true},
	{Name: "duration", Type: arrow.PrimitiveTypes.Int32, Nullable: true},
	{Name: "end_time", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "enrichments", Type: arrow.ListOf(EnrichmentStruct), Nullable: true},
	{Name: "finding_info", Type: FindingInfoStruct, Nullable: false},
	{Name: "message", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "metadata", Type: MetadataStruct, Nullable: false},
	{Name: "resources", Type: arrow.ListOf(ResourceDetailsStruct), Nullable: true},
	{Name: "severity", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "severity_id", Type: arrow.PrimitiveTypes.Int32, Nullable: false},
	{Name: "observables", Type: arrow.ListOf(ObservableStruct), Nullable: true},
	{Name: "raw_data", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "start_time", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "status", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "status_code", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "status_detail", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "status_id", Type: arrow.PrimitiveTypes.Int32, Nullable: true},
	{Name: "timezone_offset", Type: arrow.PrimitiveTypes.Int32, Nullable: true},
	{Name: "type_uid", Type: arrow.PrimitiveTypes.Int64, Nullable: false},
	{Name: "type_name", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "unmapped", Type: arrow.BinaryTypes.String, Nullable: true},
	{Name: "vulnerabilities", Type: arrow.ListOf(VulnerabilityDetailsStruct), Nullable: true},
}

var VulnerabilityFindingStruct = arrow.StructOf(VulnerabilityFindingFields...)

var VulnerabilityFindingClassname = "vulnerability_finding"

type VulnerabilityFinding struct {
	Time            time.Time              `json:"time" parquet:"time"`
	EventDay        time.Time              `json:"event_day" parquet:"event_day"` // Used for partitioning
	Filename        string                 `json:"filename" parquet:"filename"`   // Used for partitioning
	ActivityID      int32                  `json:"activity_id" parquet:"activity_id"`
	ActivityName    *string                `json:"activity_name" parquet:"activity_name"`
	CategoryUID     int32                  `json:"category_uid" parquet:"category_uid"`
	CategoryName    *string                `json:"category_name" parquet:"category_name"`
	ClassUID        int32                  `json:"class_uid" parquet:"class_uid"`
	ClassName       *string                `json:"class_name" parquet:"class_name"`
	Comment         *string                `json:"comment" parquet:"comment"`
	Confidence      *string                `json:"confidence" parquet:"confidence"`
	ConfidenceID    *int32                 `json:"confidence_id" parquet:"confidence_id"`
	ConfidenceScore *int32                 `json:"confidence_score" parquet:"confidence_score"`
	Count           *int32                 `json:"count" parquet:"count"`
	Duration        *int32                 `json:"duration" parquet:"duration"`
	EndTime         *time.Time             `json:"end_time" parquet:"end_time"`
	Enrichments     *[]Enrichment          `json:"enrichments,omitempty" parquet:"enrichments"`
	FindingInfo     FindingInfo            `json:"finding_info" parquet:"finding_info"`
	Message         *string                `json:"message" parquet:"message"`
	Metadata        Metadata               `json:"metadata" parquet:"metadata"`
	Resources       []ResourceDetails      `json:"resources,omitempty" parquet:"resources"`
	Severity        *string                `json:"severity" parquet:"severity"`
	SeverityID      int32                  `json:"severity_id" parquet:"severity_id"`
	Observables     []Observable           `json:"observables,omitempty" parquet:"observables"`
	RawData         *string                `json:"raw_data" parquet:"raw_data"`
	StartTime       *time.Time             `json:"start_time" parquet:"start_time"`
	Status          *string                `json:"status" parquet:"status"`
	StatusCode      *string                `json:"status_code" parquet:"status_code"`
	StatusDetail    *string                `json:"status_detail" parquet:"status_detail"`
	StatusID        *int32                 `json:"status_id" parquet:"status_id"`
	TimezoneOffset  *int32                 `json:"timezone_offset" parquet:"timezone_offset"`
	TypeUID         int64                  `json:"type_uid" parquet:"type_uid"`
	TypeName        *string                `json:"type_name" parquet:"type_name"`
	Unmapped        string                 `json:"unmapped" parquet:"unmapped"`
	Vulnerabilities []VulnerabilityDetails `json:"vulnerabilities" parquet:"vulnerabilities"`
}

type VulnerabilityFindingDTO struct {
	Time            time.Time `json:"time" parquet:"time"`
	EventDay        time.Time `json:"event_day" parquet:"event_day"` // Used for partitioning
	Filename        string    `json:"filename" parquet:"filename"`   // Used for partitioning
	ActivityID      int32     `json:"activity_id" parquet:"activity_id"`
	ActivityName    *string   `json:"activity_name" parquet:"activity_name"`
	CategoryUID     int32     `json:"category_uid" parquet:"category_uid"`
	CategoryName    *string   `json:"category_name" parquet:"category_name"`
	ClassUID        int32     `json:"class_uid" parquet:"class_uid"`
	ClassName       *string   `json:"class_name" parquet:"class_name"`
	Comment         *string   `json:"comment" parquet:"comment"`
	Confidence      *string   `json:"confidence" parquet:"confidence"`
	ConfidenceID    *int32    `json:"confidence_id" parquet:"confidence_id"`
	ConfidenceScore *int32    `json:"confidence_score" parquet:"confidence_score"`
	Count           *int32    `json:"count" parquet:"count"`
	Duration        *int32    `json:"duration" parquet:"duration"`
	EndTime         *DBTime   `json:"end_time" parquet:"end_time"`
	Enrichments     JSONB     `json:"enrichments,omitempty" parquet:"enrichments"`
	FindingInfo     JSONB     `json:"finding_info" parquet:"finding_info"`
	Message         *string   `json:"message" parquet:"message"`
	Metadata        JSONB     `json:"metadata" parquet:"metadata"`
	Resources       JSONB     `json:"resources,omitempty" parquet:"resources"`
	Severity        *string   `json:"severity" parquet:"severity"`
	SeverityID      int32     `json:"severity_id" parquet:"severity_id"`
	Observables     JSONB     `json:"observables,omitempty" parquet:"observables"`
	RawData         *string   `json:"raw_data" parquet:"raw_data"`
	StartTime       *DBTime   `json:"start_time" parquet:"start_time"`
	Status          *string   `json:"status" parquet:"status"`
	StatusCode      *string   `json:"status_code" parquet:"status_code"`
	StatusDetail    *string   `json:"status_detail" parquet:"status_detail"`
	StatusID        *int32    `json:"status_id" parquet:"status_id"`
	TimezoneOffset  *int32    `json:"timezone_offset" parquet:"timezone_offset"`
	TypeUID         int64     `json:"type_uid" parquet:"type_uid"`
	TypeName        *string   `json:"type_name" parquet:"type_name"`
	Unmapped        string    `json:"unmapped" parquet:"unmapped"`
	Vulnerabilities JSONB     `json:"vulnerabilities" parquet:"vulnerabilities"`
}

func (dto *VulnerabilityFindingDTO) ToStruct() (*VulnerabilityFinding, error) {
	var vf VulnerabilityFinding

	vf.Time = dto.Time
	vf.EventDay = dto.EventDay
	vf.Filename = dto.Filename
	vf.ActivityID = dto.ActivityID
	vf.ActivityName = dto.ActivityName
	vf.CategoryUID = dto.CategoryUID
	vf.CategoryName = dto.CategoryName
	vf.ClassUID = dto.ClassUID
	vf.ClassName = dto.ClassName
	vf.Comment = dto.Comment
	vf.Confidence = dto.Confidence
	vf.ConfidenceID = dto.ConfidenceID
	vf.ConfidenceScore = dto.ConfidenceScore
	vf.Count = dto.Count
	vf.Duration = dto.Duration
	vf.Message = dto.Message
	vf.Severity = dto.Severity
	vf.SeverityID = dto.SeverityID
	vf.RawData = dto.RawData
	vf.Status = dto.Status
	vf.StatusCode = dto.StatusCode
	vf.StatusDetail = dto.StatusDetail
	vf.StatusID = dto.StatusID
	vf.TimezoneOffset = dto.TimezoneOffset
	vf.TypeUID = dto.TypeUID
	vf.TypeName = dto.TypeName
	vf.Unmapped = dto.Unmapped

	if dto.EndTime != nil && !dto.EndTime.IsZero() {
		vf.EndTime = &dto.EndTime.Time
	}

	if dto.StartTime != nil && !dto.StartTime.IsZero() {
		vf.StartTime = &dto.StartTime.Time
	}

	if err := json.Unmarshal(dto.Enrichments, &vf.Enrichments); err != nil {
		return nil, err
	}

	if err := json.Unmarshal(dto.FindingInfo, &vf.FindingInfo); err != nil {
		return nil, err
	}

	if err := json.Unmarshal(dto.Metadata, &vf.Metadata); err != nil {
		return nil, err
	}

	if err := json.Unmarshal(dto.Resources, &vf.Resources); err != nil {
		return nil, err
	}

	if err := json.Unmarshal(dto.Observables, &vf.Observables); err != nil {
		return nil, err
	}

	if err := json.Unmarshal(dto.Vulnerabilities, &vf.Vulnerabilities); err != nil {
		return nil, err
	}

	return &vf, nil
}
